name: vulncheck

on:
  push:                                       
    branches:
      - main

jobs:
  build:
    name: Building
    runs-on: ubuntu-latest
    steps:
      - run: echo "COMPILACIÃ“N DE APLICATIVO"

  test:
    name: Testing
    runs-on: ubuntu-latest
    needs: build
    steps:
      - run: echo "PRUEBAS EN APLICATIVO"

  sca:
    name: Software Composition Analysis
    runs-on: ubuntu-latest
    needs: test
    steps:
      - uses: actions/checkout@v2
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
      
      - name: Install dependencies
        run: npm ci || npm install
      
      # Snyk
      - name: Run Snyk to check for vulnerabilities
        uses: snyk/actions/node@master
        continue-on-error: true
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --json-file-output=snyk-results.json
      
      # OWASP Dependency-Check
      - name: Run OWASP Dependency-Check
        run: |
          docker run --rm -v $(pwd):/src \
            owasp/dependency-check:latest \
            --scan /src \
            --format JSON \
            --out /src/dependency-check-report.json \
            --enableExperimental
        continue-on-error: true
      
      - name: Upload SCA Results
        uses: actions/upload-artifact@v4
        with:
          name: SCA-Results
          path: |
            snyk-results.json
            dependency-check-report.json
        if: always()

  secret_scanning:
    name: Secret Scanning
    runs-on: ubuntu-latest
    needs: test
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0
    
      - name: Run TruffleHog
        run: |
          docker run --rm -v $(pwd):/src \
            trufflesecurity/trufflehog:latest \
            filesystem /src \
            --json > trufflehog-output.json || true
        continue-on-error: true
      
      - name: Upload Secret Scanning Results
        uses: actions/upload-artifact@v4
        with:
          name: Secret-Scanning-Results
          path: |
            trufflehog-output.json
        if: always()

  sast:
    name: Satatic Testing (SAST)
    runs-on: ubuntu-latest
    needs: [sca,secret_scanning]
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
      
      - name: Install dependencies
        run: npm ci || npm install
      
      # ESLint
      - name: Run ESLint Security
        run: |
          npm install --save-dev eslint eslint-plugin-security || true
          npx eslint . --ext .js,.jsx,.ts,.tsx \
            --format json \
            --output-file eslint-results.json || true
        continue-on-error: true
      
      # NodeJsScan
      - name: Run NodeJsScan
        run: |
          docker run --rm -v $(pwd):/src \
            opensecurity/nodejsscan:latest \
            /src \
            --json > nodejsscan-results.json || true
        continue-on-error: true
      
      # Semgrep
      - name: Run Semgrep
        run: |
          docker run --rm -v $(pwd):/src \
            returntocorp/semgrep \
            semgrep scan /src \
            --config=auto \
            --json > semgrep-results.json || true
        continue-on-error: true
      
      - name: Upload SAST Results
        uses: actions/upload-artifact@v4
        with:
          name: SAST-Results
          path: |
            eslint-results.json
            nodejsscan-results.json
            semgrep-results.json
        if: always()